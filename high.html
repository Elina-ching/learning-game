<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>å…ƒç´ åŸå ¡æ‹¼æ‹¼æ¨‚ï½œé«˜ä¸­ç‰ˆ</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Tone.js éŸ³æ•ˆ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap");

    body {
      font-family: "Noto Sans TC", sans-serif;
      background-color: #e0f2fe;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      touch-action: none;
      overflow: hidden;
    }

    #game-container {
      max-width: 960px;
      width: 100%;
      height: 100vh;
      background: #f9fafb;
      box-shadow: 0 0 25px rgba(15, 23, 42, 0.18);
      display: flex;
      flex-direction: column;
    }

    /* ===== é€±æœŸè¡¨æ ¼å­ ===== */
    .table-wrapper {
      position: relative;
      flex-grow: 1;
      overflow: auto;
      padding: 16px;
      background: radial-gradient(circle at top, #ffffff 0%, #dbeafe 45%, #bfdbfe 100%);
      border-bottom: 4px solid #93c5fd;
    }

    .periodic-grid {
      display: grid;
      grid-template-columns: repeat(18, 1fr);
      grid-template-rows: repeat(7, 1fr);
      gap: 2px;
      width: 900px;
      height: 450px;
      pointer-events: none;
      position: absolute;
      inset: 0;
      margin: auto;
    }

    .grid-cell {
      border: 1px dashed rgba(148, 163, 184, 0.5);
      background-color: rgba(255, 255, 255, 0.7);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #94a3b8;
      position: relative;
    }

    .grid-cell span.z {
      position: absolute;
      top: 2px;
      left: 4px;
      font-size: 9px;
      opacity: 0.7;
    }

    .grid-cell span.sym {
      font-size: 14px;
      color: #cbd5f5;
    }

    /* ===== æ¼‚æµ®å…ƒç´ å¡ç‰‡ ===== */
    .floating-block {
      position: absolute;
      width: 52px;
      height: 52px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 20px;
      color: #ffffff;
      box-shadow: 0 10px 16px rgba(15, 23, 42, 0.25);
      cursor: pointer;
      user-select: none;
      transition: transform 0.18s, box-shadow 0.18s,
        top 0.6s cubic-bezier(0.34, 1.56, 0.64, 1),
        left 0.6s cubic-bezier(0.34, 1.56, 0.64, 1),
        width 0.3s ease, height 0.3s ease;
      z-index: 10;
    }

    .floating-block:active {
      transform: translateY(2px) scale(0.97);
      box-shadow: 0 6px 12px rgba(15, 23, 42, 0.18);
    }

    .floating-block.selected {
      border: 3px solid #facc15;
      box-shadow: 0 0 20px rgba(250, 204, 21, 0.95);
      transform: scale(1.16) rotate(0deg);
      z-index: 40;
    }

    .floating-block.solved {
      border-radius: 4px;
      box-shadow: inset 0 0 6px rgba(15, 23, 42, 0.35);
      pointer-events: none;
      z-index: 5;
    }

    /* ===== shake éŒ¯èª¤å‹•ç•« ===== */
    @keyframes shake {
      0%, 100% {
        transform: translateX(0);
      }
      20%, 60% {
        transform: translateX(-5px);
      }
      40%, 80% {
        transform: translateX(5px);
      }
    }

    .shake {
      animation: shake 0.24s ease-in-out;
    }

    /* AI loading å°é»é»ï¼ˆçµ¦æœªä¾†ç”¨ï¼Œç¾åœ¨æ²’ç”¨åˆ°ä¹Ÿå¯ä»¥ç•™è‘—ï¼‰ */
    .dot-flashing {
      position: relative;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background-color: #2563eb;
      animation: dot-flashing 1s infinite linear alternate;
      animation-delay: 0.5s;
    }
    .dot-flashing::before,
    .dot-flashing::after {
      content: "";
      position: absolute;
      top: 0;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background-color: #2563eb;
    }
    .dot-flashing::before {
      left: -15px;
      animation: dot-flashing 1s infinite alternate;
      animation-delay: 0s;
    }
    .dot-flashing::after {
      left: 15px;
      animation: dot-flashing 1s infinite alternate;
      animation-delay: 1s;
    }
    @keyframes dot-flashing {
      0% { background-color: #2563eb; }
      50%,100% { background-color: rgba(37,99,235,0.2); }
    }
  </style>
</head>
<body class="bg-sky-200">
  <div id="game-container">
    <!-- é ‚ç«¯æ¨™é¡Œåˆ— -->
    <header
      class="bg-blue-600 text-white px-5 py-4 flex items-center justify-between shadow-md"
    >
      <div>
        <h1 class="text-xl md:text-2xl font-extrabold flex items-center gap-2">
          <span>ğŸ°</span>
          <span>å…ƒç´ åŸå ¡æ‹¼æ‹¼æ¨‚ï½œé«˜ä¸­ç‰ˆ</span>
        </h1>
        <p class="text-xs md:text-sm text-blue-100 mt-1">
          æ±Ÿæ±Ÿèˆ‡é«˜æ‰‹æ”œæ‰‹æ‰“é€ ï½œé«˜ä¸­èª²ç¶±å¸¸è¦‹ 65 å€‹å…ƒç´ 
        </p>
        <p class="text-[11px] md:text-xs text-blue-100">
          é»é¸å…ƒç´  â†’ ç”¨éµç›¤è¼¸å…¥ç¬¦è™Ÿ â†’ æŒ‰ Enter ç¢ºèªï¼
        </p>
      </div>

      <div class="text-right">
        <div
          id="progressDisplay"
          class="text-3xl font-black tracking-tight drop-shadow-sm"
        >
          0/65
        </div>
        <button
          onclick="askAIHint()"
          class="mt-2 inline-flex items-center gap-1 text-[11px] md:text-xs bg-yellow-300 text-blue-900 px-3 py-1.5 rounded-full font-bold shadow-lg hover:bg-yellow-200 active:scale-95 transition"
        >
          âœ¨ å°æç¤º (é›¢ç·šç‰ˆ)
        </button>
      </div>
    </header>

    <!-- ä¸­é–“ï¼šåŸå ¡æ ¼å­ï¼‹é£„æµ®å…ƒç´  -->
    <main class="table-wrapper" id="tableArea">
      <!-- èƒŒæ™¯é€±æœŸè¡¨æ ¼å­ -->
      <div class="periodic-grid" id="ghostGrid"></div>

      <!-- å…ƒç´ å¡ç‰‡å®¹å™¨ -->
      <div
        id="blocksContainer"
        class="absolute inset-0 w-[900px] h-[450px] mx-auto my-auto pointer-events-none"
      ></div>
    </main>

    <!-- åº•éƒ¨ï¼šç›®å‰é¸æ“‡ï¼‹è¼¸å…¥é¡¯ç¤ºï¼‹æŒ‰éˆ• -->
    <footer
      class="bg-white px-4 md:px-6 py-3 border-t-4 border-slate-300 flex flex-col md:flex-row items-center gap-3 md:gap-4"
    >
      <div class="flex items-center gap-2 w-full md:w-auto">
        <span class="text-sm md:text-base text-slate-500 font-semibold"
          >ç›®å‰é¸æ“‡ï¼š</span
        >
        <span
          id="currentSelection"
          class="text-xl md:text-2xl font-extrabold text-blue-600 transition-all duration-200"
          >è«‹é»é¸å…ƒç´ </span
        >
      </div>

      <div
        class="flex items-center gap-2 w-full md:w-auto justify-between md:justify-start"
      >
        <span class="text-sm md:text-base text-slate-500 font-semibold"
          >è¼¸å…¥ï¼š</span
        >
        <div
          id="inputDisplay"
          class="bg-slate-100 px-5 py-2 rounded-xl text-3xl font-mono font-bold tracking-[0.6em] min-w-[120px] text-center border-4 border-blue-200 transition duration-100"
        >
          _
        </div>
      </div>

      <div
        class="flex flex-1 justify-end gap-2 w-full md:w-auto mt-1 md:mt-0"
      >
        <button
          onclick="clearInput()"
          class="flex-1 md:flex-none bg-red-500 hover:bg-red-600 active:scale-95 text-white text-xs md:text-sm font-bold py-2 px-4 rounded-full shadow-md transition inline-flex items-center justify-center gap-1"
        >
          âŒ« æ¸…é™¤ (Backspace)
        </button>
        <button
          onclick="checkAnswer()"
          class="flex-1 md:flex-none bg-green-500 hover:bg-green-600 active:scale-95 text-white text-xs md:text-sm font-bold py-2 px-4 rounded-full shadow-md transition inline-flex items-center justify-center gap-1"
        >
          ç¢ºèª (Enter) âœ“
        </button>
      </div>
    </footer>
  </div>

  <!-- å°æç¤º Modal -->
  <div
    id="aiModal"
    class="hidden fixed inset-0 bg-black/75 flex items-center justify-center z-50 px-4"
  >
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 relative">
      <button
        onclick="closeAiModal()"
        class="absolute top-2 right-3 text-slate-400 hover:text-slate-600 text-2xl leading-none"
      >
        &times;
      </button>
      <h3
        class="text-lg md:text-xl font-bold text-blue-600 mb-3 flex items-center gap-2"
      >
        <span>ğŸ§ª</span>
        <span>é«˜æ‰‹å°æé†’</span>
      </h3>
      <div
        id="aiContent"
        class="ai-content text-slate-700 text-sm leading-relaxed min-h-[100px] max-h-[60vh] overflow-y-auto"
      ></div>
    </div>
  </div>

  <!-- é€šé—œ Modal -->
  <div
    id="winModal"
    class="hidden fixed inset-0 bg-blue-900/95 flex flex-col items-center justify-center z-50 text-white p-6"
  >
    <div
      class="p-8 rounded-2xl bg-white/10 backdrop-blur-md text-center max-w-lg w-full border border-blue-200/40"
    >
      <h2 class="text-5xl md:text-6xl font-extrabold mb-4 text-yellow-300">
        ä»»å‹™å®Œæˆï¼
      </h2>
      <p class="text-xl md:text-2xl mb-8 font-light">
        é«˜ä¸­ç‰ˆå…ƒç´ åŸå ¡æ‹¼å¥½å•¦ï¼Œå¦³çš„åŒ–å­¸åº•å­è¶…æ‰å¯¦ ğŸ’ª
      </p>
      <button
        onclick="location.reload()"
        class="bg-emerald-400 hover:bg-emerald-500 active:scale-95 text-white font-bold py-3 px-9 rounded-full text-lg shadow-xl"
      >
        å†ç©ä¸€æ¬¡
      </button>
    </div>
  </div>

  <script>
    // ===== é«˜ä¸­èª²ç¶±å¸¸è¦‹ 65 å€‹å…ƒç´  =====
    const elements = [
      // Period 1
      { z: 1,  s: "H",  n: "æ°«", r: 1, c: 1,  color: "#f97373" },
      { z: 2,  s: "He", n: "æ°¦", r: 1, c: 18, color: "#38bdf8" },

      // Period 2
      { z: 3,  s: "Li", n: "é‹°", r: 2, c: 1,  color: "#fb923c" },
      { z: 4,  s: "Be", n: "éˆ¹", r: 2, c: 2,  color: "#22c55e" },
      { z: 5,  s: "B",  n: "ç¡¼", r: 2, c: 13, color: "#8b5cf6" },
      { z: 6,  s: "C",  n: "ç¢³", r: 2, c: 14, color: "#6b7280" },
      { z: 7,  s: "N",  n: "æ°®", r: 2, c: 15, color: "#f97373" },
      { z: 8,  s: "O",  n: "æ°§", r: 2, c: 16, color: "#f97373" },
      { z: 9,  s: "F",  n: "æ°Ÿ", r: 2, c: 17, color: "#facc15" },
      { z: 10, s: "Ne", n: "æ°–", r: 2, c: 18, color: "#38bdf8" },

      // Period 3
      { z: 11, s: "Na", n: "éˆ‰", r: 3, c: 1,  color: "#fb923c" },
      { z: 12, s: "Mg", n: "é‚", r: 3, c: 2,  color: "#22c55e" },
      { z: 13, s: "Al", n: "é‹", r: 3, c: 13, color: "#a855f7" },
      { z: 14, s: "Si", n: "çŸ½", r: 3, c: 14, color: "#8b5cf6" },
      { z: 15, s: "P",  n: "ç£·", r: 3, c: 15, color: "#facc15" },
      { z: 16, s: "S",  n: "ç¡«", r: 3, c: 16, color: "#facc15" },
      { z: 17, s: "Cl", n: "æ°¯", r: 3, c: 17, color: "#facc15" },
      { z: 18, s: "Ar", n: "æ°¬", r: 3, c: 18, color: "#38bdf8" },

      // Period 4
      { z: 19, s: "K",  n: "é‰€", r: 4, c: 1,  color: "#fb923c" },
      { z: 20, s: "Ca", n: "éˆ£", r: 4, c: 2,  color: "#22c55e" },
      { z: 21, s: "Sc", n: "éˆ§", r: 4, c: 3,  color: "#9ca3af" },
      { z: 22, s: "Ti", n: "éˆ¦", r: 4, c: 4,  color: "#9ca3af" },
      { z: 23, s: "V",  n: "é‡©", r: 4, c: 5,  color: "#9ca3af" },
      { z: 24, s: "Cr", n: "é‰»", r: 4, c: 6,  color: "#9ca3af" },
      { z: 25, s: "Mn", n: "éŒ³", r: 4, c: 7,  color: "#9ca3af" },
      { z: 26, s: "Fe", n: "éµ", r: 4, c: 8,  color: "#9ca3af" },
      { z: 27, s: "Co", n: "éˆ·", r: 4, c: 9,  color: "#9ca3af" },
      { z: 28, s: "Ni", n: "é³", r: 4, c: 10, color: "#9ca3af" },
      { z: 29, s: "Cu", n: "éŠ…", r: 4, c: 11, color: "#b45309" },
      { z: 30, s: "Zn", n: "é‹…", r: 4, c: 12, color: "#9ca3af" },
      { z: 31, s: "Ga", n: "éµ", r: 4, c: 13, color: "#a855f7" },
      { z: 32, s: "Ge", n: "éº", r: 4, c: 14, color: "#8b5cf6" },
      { z: 33, s: "As", n: "ç ·", r: 4, c: 15, color: "#facc15" },
      { z: 34, s: "Se", n: "ç¡’", r: 4, c: 16, color: "#facc15" },
      { z: 35, s: "Br", n: "æº´", r: 4, c: 17, color: "#f97316" },
      { z: 36, s: "Kr", n: "æ°ª", r: 4, c: 18, color: "#38bdf8" },

      // Period 5
      { z: 37, s: "Rb", n: "éŠ£", r: 5, c: 1,  color: "#fb923c" },
      { z: 38, s: "Sr", n: "é¶", r: 5, c: 2,  color: "#22c55e" },
      { z: 39, s: "Y",  n: "é‡”", r: 5, c: 3,  color: "#9ca3af" },
      { z: 40, s: "Zr", n: "é‹¯", r: 5, c: 4,  color: "#9ca3af" },
      { z: 41, s: "Nb", n: "éˆ®", r: 5, c: 5,  color: "#9ca3af" },
      { z: 42, s: "Mo", n: "é‰¬", r: 5, c: 6,  color: "#9ca3af" },
      { z: 44, s: "Ru", n: "é‡•", r: 5, c: 8,  color: "#9ca3af" },
      { z: 45, s: "Rh", n: "éŠ ", r: 5, c: 9,  color: "#9ca3af" },
      { z: 46, s: "Pd", n: "éˆ€", r: 5, c: 10, color: "#9ca3af" },
      { z: 47, s: "Ag", n: "éŠ€", r: 5, c: 11, color: "#b45309" },
      { z: 48, s: "Cd", n: "é˜", r: 5, c: 12, color: "#9ca3af" },
      { z: 49, s: "In", n: "éŠ¦", r: 5, c: 13, color: "#a855f7" },
      { z: 50, s: "Sn", n: "éŒ«", r: 5, c: 14, color: "#a855f7" },
      { z: 51, s: "Sb", n: "éŠ»", r: 5, c: 15, color: "#facc15" },
      { z: 52, s: "Te", n: "ç¢²", r: 5, c: 16, color: "#facc15" },
      { z: 53, s: "I",  n: "ç¢˜", r: 5, c: 17, color: "#f97316" },
      { z: 54, s: "Xe", n: "æ°™", r: 5, c: 18, color: "#38bdf8" },

      // Period 6ï¼ˆä¸å«é‘­ç³»ï¼Œåªæ”¶å¸¸è¦‹é‡‘å±¬ï¼‰
      { z: 55, s: "Cs", n: "éŠ«", r: 6, c: 1,  color: "#fb923c" },
      { z: 56, s: "Ba", n: "é‹‡", r: 6, c: 2,  color: "#22c55e" },
      { z: 72, s: "Hf", n: "é‰¿", r: 6, c: 4,  color: "#9ca3af" },
      { z: 73, s: "Ta", n: "é‰­", r: 6, c: 5,  color: "#9ca3af" },
      { z: 74, s: "W",  n: "é¢", r: 6, c: 6,  color: "#9ca3af" },
      { z: 75, s: "Re", n: "éŒ¸", r: 6, c: 7,  color: "#9ca3af" },
      { z: 76, s: "Os", n: "é‹¨", r: 6, c: 8,  color: "#9ca3af" },
      { z: 77, s: "Ir", n: "éŠ¥", r: 6, c: 9,  color: "#9ca3af" },
      { z: 78, s: "Pt", n: "é‰‘", r: 6, c: 10, color: "#9ca3af" },
      { z: 79, s: "Au", n: "é‡‘", r: 6, c: 11, color: "#b45309" },
      { z: 80, s: "Hg", n: "æ±", r: 6, c: 12, color: "#9ca3af" },
      { z: 82, s: "Pb", n: "é‰›", r: 6, c: 14, color: "#a855f7" }
    ];

    // ===== éŠæˆ²ç‹€æ…‹ =====
    let selectedElement = null;
    let currentInput = "";
    let solvedCount = 0;
    const totalCount = elements.length;

    let correctSynth, wrongSynth;

    window.onload = () => {
      setTimeout(() => {
        initGrid();
        initBlocks();
        initAudio();
        updateProgress();
      }, 50);

      document.addEventListener("keydown", handleGlobalKeydown);
    };

    // ===== éŸ³æ•ˆåˆå§‹åŒ– =====
    function initAudio() {
      if (Tone.context.state !== "running") {
        const startAudio = () => {
          Tone.start()
            .then(() => {
              document.documentElement.removeEventListener("mousedown", startAudio);
              document.documentElement.removeEventListener("touchstart", startAudio);
            })
            .catch((e) => console.error("Audio å•Ÿå‹•å¤±æ•—ï¼š", e));
        };
        document.documentElement.addEventListener("mousedown", startAudio, { once: true });
        document.documentElement.addEventListener("touchstart", startAudio, { once: true });
      }

      correctSynth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "sine" },
        envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.4 }
      }).toDestination();

      wrongSynth = new Tone.NoiseSynth({
        noise: { type: "pink" },
        envelope: { attack: 0.005, decay: 0.15, sustain: 0, release: 0.15 }
      }).toDestination();
    }

    function playCorrect() {
      if (Tone.context.state === "running" && correctSynth) {
        correctSynth.triggerAttackRelease(["C5", "E5", "G5"], "8n");
      }
    }

    function playWrong() {
      if (Tone.context.state === "running" && wrongSynth) {
        wrongSynth.triggerAttackRelease("16n");
      }
    }

    // ===== å»ºç«‹èƒŒæ™¯æ ¼å­ =====
    function initGrid() {
      const grid = document.getElementById("ghostGrid");
      grid.innerHTML = "";

      const gridWidth = 900;
      const gridHeight = 450;
      grid.style.width = gridWidth + "px";
      grid.style.height = gridHeight + "px";

      for (let r = 1; r <= 7; r++) {
        for (let c = 1; c <= 18; c++) {
          const cell = document.createElement("div");
          cell.className = "grid-cell";
          cell.dataset.row = r;
          cell.dataset.col = c;

          const el = elements.find((e) => e.r === r && e.c === c);
          if (el) {
            cell.id = `slot-${el.s}`;
            cell.innerHTML = `
              <span class="z">${el.z}</span>
              <span class="sym">${el.s}</span>
            `;
          } else if (r === 6 && c >= 3 && c <= 10) {
            cell.innerHTML = "57â€“71";
          } else if (r === 7 && c >= 3 && c <= 10) {
            cell.innerHTML = "89â€“103";
          } else {
            cell.style.visibility = "hidden";
          }

          grid.appendChild(cell);
        }
      }

      const blockContainer = document.getElementById("blocksContainer");
      blockContainer.style.width = gridWidth + "px";
      blockContainer.style.height = gridHeight + "px";
    }

    // ===== å»ºç«‹é£„æµ®å…ƒç´ å¡ç‰‡ =====
    function initBlocks() {
      const container = document.getElementById("blocksContainer");
      container.innerHTML = "";

      const containerWidth = 900;
      const containerHeight = 450;
      const padding = 60;

      elements.forEach((el) => {
        const block = document.createElement("div");
        block.className = "floating-block pointer-events-auto";
        block.id = `block-${el.s}`;
        block.style.backgroundColor = el.color;
        block.textContent = el.n;

        const randTop =
          Math.random() * (containerHeight - padding * 2) + padding;
        const randLeft =
          Math.random() * (containerWidth - padding * 2) + padding;
        const randRot = Math.random() * 30 - 15;

        block.style.top = randTop + "px";
        block.style.left = randLeft + "px";
        block.style.transform = `rotate(${randRot}deg)`;

        block.onclick = () => selectBlock(el, block);
        container.appendChild(block);
      });
    }

    // ===== é¸æ“‡å¡ç‰‡ =====
    function selectBlock(elData, blockDom) {
      if (blockDom.classList.contains("solved")) return;

      document
        .querySelectorAll(".floating-block.selected")
        .forEach((b) => b.classList.remove("selected"));

      selectedElement = elData;
      currentInput = "";
      blockDom.classList.add("selected");

      const label = document.getElementById("currentSelection");
      label.textContent = elData.n;   // åªé¡¯ç¤ºä¸­æ–‡åå­—
      label.style.color = elData.color;

      updateInputDisplay();

      const tableWrapper = document.getElementById("tableArea");
      const blockRect = blockDom.getBoundingClientRect();
      const wrapperRect = tableWrapper.getBoundingClientRect();

      const scrollLeft =
        blockRect.left -
        wrapperRect.left +
        tableWrapper.scrollLeft -
        wrapperRect.width / 2 +
        blockRect.width / 2;
      const scrollTop =
        blockRect.top -
        wrapperRect.top +
        tableWrapper.scrollTop -
        wrapperRect.height / 2 +
        blockRect.height / 2;

      tableWrapper.scrollTo({
        left: scrollLeft,
        top: scrollTop,
        behavior: "smooth"
      });
    }

    // ===== éµç›¤äº‹ä»¶ =====
    function handleGlobalKeydown(event) {
      if (!document.getElementById("aiModal").classList.contains("hidden")) {
        return;
      }
      if (!document.getElementById("winModal").classList.contains("hidden")) {
        return;
      }

      const key = event.key;

      if (key.length === 1 && /[a-zA-Z]/.test(key)) {
        event.preventDefault();
        handleKey(key.toUpperCase());
      } else if (key === "Backspace" || key === "Delete") {
        event.preventDefault();
        clearInput();
      } else if (key === "Enter") {
        event.preventDefault();
        checkAnswer();
      }
    }

    function handleKey(char) {
      if (!selectedElement) {
        const label = document.getElementById("currentSelection");
        label.classList.add("shake");
        setTimeout(() => label.classList.remove("shake"), 250);
        return;
      }

      const targetSym = selectedElement.s.toUpperCase();

      if (currentInput.length < targetSym.length) {
        currentInput += char;
        updateInputDisplay();
      }

      if (
        currentInput.length === targetSym.length &&
        targetSym.length === 1
      ) {
        checkAnswer();
      }
    }

    // ===== æª¢æŸ¥ç­”æ¡ˆ =====
    function checkAnswer() {
      if (!selectedElement) return;

      const targetSym = selectedElement.s.toUpperCase();
      const display = document.getElementById("inputDisplay");

      if (currentInput === targetSym) {
        playCorrect();

        const block = document.getElementById(`block-${selectedElement.s}`);
        const slot = document.getElementById(`slot-${selectedElement.s}`);

        const slotRect = slot.getBoundingClientRect();
        const containerRect =
          document.getElementById("blocksContainer").getBoundingClientRect();

        const targetLeft = slotRect.left - containerRect.left;
        const targetTop = slotRect.top - containerRect.top;

        block.style.transform = "rotate(0deg) scale(1)";
        block.style.left = targetLeft + "px";
        block.style.top = targetTop + "px";
        block.style.width = slotRect.width + "px";
        block.style.height = slotRect.height + "px";

        block.classList.remove("selected");
        block.classList.add("solved");

        block.innerHTML = `
          <div class="flex flex-col items-center leading-none text-white">
            <span class="text-[10px] opacity-80">${selectedElement.z}</span>
            <span class="text-lg">${selectedElement.s}</span>
          </div>
        `;

        selectedElement = null;
        currentInput = "";
        updateInputDisplay();

        const label = document.getElementById("currentSelection");
        label.textContent = "âœ… æ­¸ä½æˆåŠŸï¼å†é¸ä¸€å€‹å§ï½";
        label.style.color = "#16a34a";

        solvedCount++;
        updateProgress();

        if (solvedCount === totalCount) {
          setTimeout(
            () =>
              document
                .getElementById("winModal")
                .classList.remove("hidden"),
            800
          );
        }
      } else if (currentInput.length > 0) {
        playWrong();
        display.classList.add("shake", "text-red-600");

        setTimeout(() => {
          display.classList.remove("shake", "text-red-600");
          currentInput = "";
          updateInputDisplay();
        }, 350);
      }
    }

    function clearInput() {
      currentInput = "";
      updateInputDisplay();
    }

    function updateInputDisplay() {
      const display = document.getElementById("inputDisplay");
      const len = selectedElement ? selectedElement.s.length : 1;
      let show = currentInput.padEnd(len, "_");

      if (selectedElement) {
        const targetSym = selectedElement.s.toUpperCase();
        if (targetSym.startsWith(currentInput)) {
          display.classList.remove("text-red-500");
          display.classList.add("text-slate-800");
        } else {
          display.classList.add("text-red-500");
          display.classList.remove("text-slate-800");
        }
      } else {
        display.classList.remove("text-red-500", "text-slate-800");
        display.classList.add("text-blue-600");
      }

      display.textContent = show.split("").join(" ");
    }

    function updateProgress() {
      document.getElementById(
        "progressDisplay"
      ).textContent = `${solvedCount}/${totalCount}`;
    }

    // ===== æœ¬åœ°ç‰ˆå°æç¤ºï¼ˆä¸é€£ç¶²ã€ä¸èŠ±é¡åº¦ï¼‰ =====
    function askAIHint() {
      let target = selectedElement;

      if (!target) {
        const unsolved = elements.filter((e) => {
          const b = document.getElementById(`block-${e.s}`);
          return b && !b.classList.contains("solved");
        });

        if (unsolved.length === 0) {
          showAiModal("å¦³å·²ç¶“å…¨éƒ¨æ‹¼å¥½äº†ï¼å¯ä»¥å»æŒ‘æˆ°å…¨å…ƒç´ ç‰ˆå›‰ ğŸŒˆ", false);
          return;
        }

        target = unsolved[Math.floor(Math.random() * unsolved.length)];
        const b = document.getElementById(`block-${target.s}`);
        if (b) selectBlock(target, b);
      }

      const hintHtml = `
        <p class="text-base leading-relaxed">
          ğŸ‘‹ å¦³ç¾åœ¨çœ‹çš„æ˜¯ï¼š
          <strong class="text-blue-700 text-lg">${target.n}</strong><br>
          å®ƒçš„åŸå­åºæ˜¯ï¼š
          <strong class="text-green-600 text-lg">${target.z}</strong>ã€‚<br><br>
          æƒ³åƒå®ƒåœ¨é€±æœŸè¡¨çš„é€™ä¸€æ ¼ï¼ŒæŠŠé¡è‰²å’Œä½ç½®ä¸€èµ·è¨˜ä½ï¼Œå°±æ›´ä¸æœƒå¿˜è¨˜ç¬¦è™Ÿ <strong>${target.s}</strong> å›‰ï¼
        </p>
      `;

      showAiModal(hintHtml, false);
    }

    function showAiModal(content, isLoading) {
      const modal = document.getElementById("aiModal");
      const contentDiv = document.getElementById("aiContent");

      modal.classList.remove("hidden");

      if (isLoading) {
        contentDiv.innerHTML = "";
      } else {
        contentDiv.innerHTML = content;
      }
    }

    function closeAiModal() {
      document.getElementById("aiModal").classList.add("hidden");
    }
  </script>
</body>
</html>
